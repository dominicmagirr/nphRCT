df_control_event<-df[df$group == "control" & df$event == 1,]
#args <- list(ylim=c(min(df_cens$score_cens, df_event$score_event)-0.5,
#                    max(df_cens$score_cens, df_event$score_event)+0.5))
args <- list(ylim=c(-1,1))
inargs <- list(...)
args[names(inargs)] <- inargs
do.call(plot,c(list(x=df$x_pos,
type="n",xlab="Rank",xaxt="n",ylab="Score"),args))
axis(side=1, labels=df$rank, at=df$x_pos)
points(x=df_experimental_cens$x_pos,y=df_experimental_cens$standardized_score,pch=21,bg="white")
points(x=df_experimental_event$x_pos,y=df_experimental_event$standardized_score,pch=21,bg="black")
points(x=df_control_cens$x_pos,y=df_control_cens$standardized_score,pch=20,bg="white")
points(x=df_control_event$x_pos,y=df_control_event$standardized_score,pch=20,bg="black")
}
###################################
scores_out<-find_scores(data=sim_data,
formula=Surv(event_time,event_status)~group,
wlr="mw",
t_star = 3
)
plot(scores_out)
#' @export
plot.wlrt_score<-function(x,...){
df<-x$df
df$x_pos<-1:nrow(df)
#df_cens<-df[df$n_censor>0,]
#df_event<-df[df$n_event>0,]
df_experimental_cens<-df[df$group == "experimental" & df$event == 0,]
df_experimental_event<-df[df$group == "experimental" & df$event == 1,]
df_control_cens<-df[df$group == "control" & df$event == 0,]
df_control_event<-df[df$group == "control" & df$event == 1,]
#args <- list(ylim=c(min(df_cens$score_cens, df_event$score_event)-0.5,
#                    max(df_cens$score_cens, df_event$score_event)+0.5))
args <- list(ylim=c(-1,1))
inargs <- list(...)
args[names(inargs)] <- inargs
do.call(plot,c(list(x=df$x_pos,
type="n",xlab="Rank",xaxt="n",ylab="Score"),args))
axis(side=1, labels=df$rank, at=df$x_pos)
points(x=df_experimental_cens$x_pos,y=df_experimental_cens$standardized_score,pch=21,bg="white")
points(x=df_experimental_event$x_pos,y=df_experimental_event$standardized_score,pch=21,bg="black")
points(x=df_control_cens$x_pos,y=df_control_cens$standardized_score,pch=21,bg="white", col = 2)
points(x=df_control_event$x_pos,y=df_control_event$standardized_score,pch=21,bg="black", col = 2)
}
plot(scores_out)
#' @export
plot.wlrt_score<-function(x,...){
df<-x$df
df$x_pos<-1:nrow(df)
#df_cens<-df[df$n_censor>0,]
#df_event<-df[df$n_event>0,]
df_experimental_cens<-df[df$group == "experimental" & df$event == 0,]
df_experimental_event<-df[df$group == "experimental" & df$event == 1,]
df_control_cens<-df[df$group == "control" & df$event == 0,]
df_control_event<-df[df$group == "control" & df$event == 1,]
#args <- list(ylim=c(min(df_cens$score_cens, df_event$score_event)-0.5,
#                    max(df_cens$score_cens, df_event$score_event)+0.5))
args <- list(ylim=c(-1,1))
inargs <- list(...)
args[names(inargs)] <- inargs
do.call(plot,c(list(x=df$x_pos,
type="n",xlab="Rank",xaxt="n",ylab="Score"),args))
axis(side=1, labels=df$rank, at=df$x_pos)
points(x=df_experimental_cens$x_pos,y=df_experimental_cens$standardized_score,pch=21,bg="white")
points(x=df_experimental_event$x_pos,y=df_experimental_event$standardized_score,pch=21,bg="black")
points(x=df_control_cens$x_pos,y=df_control_cens$standardized_score,pch=21,bg="white", col = 2)
points(x=df_control_event$x_pos,y=df_control_event$standardized_score,pch=21,bg="red", col = 2)
}
plot(scores_out)
scores_out<-find_scores(data=sim_data_strata,
formula=Surv(event_time,event_status)~group + strata(ecog),
wlr="mw",
t_star = 3
)
scores_out<-find_scores(data=sim_data_strata,
formula=Surv(event_time,event_status)~group + ecog,
wlr="mw",
t_star = 3
)
setwd("~/NPH")
setwd("~/r-package-rct-under-anticipated-delayed-effects/R")
#'   rec_period = 12,
#'   rec_power = 1,
#'   max_cal_t = 36
#' )
#' #example setting t_star
#' wlrt(formula=Surv(event_time,event_status)~group,
#'   data=sim_data,
#'   wlr="mw",
#'   t_star = 4
#' )
devtools::load_all()
#library(wlrt)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
#example setting s_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
s_star = 0.5
)
#example with 1 strata
sim_data_0 <- sim_data
sim_data_0$ecog=0
sim_data_1 <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/6,
lambda_e_1 = log(2)/6,
lambda_e_2 = log(2)/12,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
sim_data_1$ecog=1
sim_data_strata<-rbind(sim_data_0,sim_data_1)
wlrt(formula=Surv(event_time,event_status)~group+strata(ecog),
data=sim_data_strata,
wlr="mw",
t_star = 4
)
#example with 2 strata
sim_data_strata_2<-cbind(sim_data_strata,sex=rep(c("M","F"),times=100))
wlrt(formula=Surv(event_time,event_status)~group+strata(ecog)+strata(sex),
data=sim_data_strata_2,
wlr="mw",
t_star = 4
)
formula=Surv(event_time,event_status)~group
data=sim_data
wlr="mw"
t_star = 4
w<-find_weights(formula=formula,
data=data,
wlr=wlr,
t_star = t_star,
s_star = s_star,
rho = rho,
gamma = gamma,
include_cens=TRUE)
s_star = NULL
rho = NULL
gamma = NULL
w<-find_weights(formula=formula,
data=data,
wlr=wlr,
t_star = t_star,
s_star = s_star,
rho = rho,
gamma = gamma,
include_cens=TRUE)
w
df <- find_at_risk(formula=formula,
data=data,
include_cens=TRUE)
df
df$score_censored<-with(df,-cumsum(w*(n_event/n_risk)))
df$score_event<-with(df,score_censored+w)
df
formula_vars <- all.vars(formula)
time_col <- formula_vars[1]
status_col <- formula_vars[2]
group_col<-formula_vars[-(1:2)]
time_col
status_col
group_col
df<-merge(x = df[,c("t_j","score_censored","score_event")], y = data[,c("t_j","event","group")], by = "t_j", all.x = TRUE)
data$t_j<-data[[time_col]]
data$event<-data[[status_col]]
data$group<-data[[group_col]]
df<-merge(x = df[,c("t_j","score_censored","score_event")], y = data[,c("t_j","event","group")], by = "t_j", all.x = TRUE)
df
###########################################
## pick out score (event or censored) (DM)
df$score <- with(df, event * score_event + (1 - event) * score_censored)
## standardize scores to (-1, 1) (DM)
max_a <- max(df$score)
min_a <- min(df$score)
A = 2 / (max_a - min_a)
B = 1 - A * max_a
df$standardized_score <- df$score * A + B
df
df$rank<-factor(df$t_j)
levels(df$rank)<-paste0("(",1:length(unique(df$t_j)),")")
df
find_scores(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4)
scores_1 <- find_scores(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4)
sum(scores_1[group == "experimental","score"])
sum(scores_1[scores_1$group == "experimental","score"])
scores_1[scores_1$group == "experimental","score"]
sum(scores_1$df[scores_1$df$group == "experimental","score"])
#example setting s_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
s_star = 0.5
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
sum(scores_1$df[scores_1$df$group == "experimental","score"])
plot(scores_1)
x <- scores_1
df<-x$df
df$x_pos<-1:length(unique(df$rank))
1:length(unique(df$rank))
head(data)
head(sim_data)
### try changing names and see if it still works
colnames(sim_data) <- c("time", "event", "arm")
str(sim_data$arm)
sim_data$arm[sim_data$arm == "control"] <- "0"
sim_data$arm[sim_data$arm == "experimental"] <- "1"
head(sim_data)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
#example setting t_star
#wlrt(formula=Surv(event_time,event_status)~group,
#     data=sim_data,
#     wlr="mw",
#     t_star = 4
#)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
#example setting t_star
#wlrt(formula=Surv(event_time,event_status)~group,
#     data=sim_data,
#     wlr="mw",
#     t_star = 4
#)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
devtools::load_all()
#library(wlrt)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
### try changing names and see if it still works
colnames(sim_data) <- c("time", "event", "arm")
sim_data$arm[sim_data$arm == "control"] <- "0"
sim_data$arm[sim_data$arm == "experimental"] <- "1"
head(sim_data)
#example setting t_star
#wlrt(formula=Surv(event_time,event_status)~group,
#     data=sim_data,
#     wlr="mw",
#     t_star = 4
#)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
devtools::load_all()
#library(wlrt)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
### try changing names and see if it still works
colnames(sim_data) <- c("time", "event", "arm")
sim_data$arm[sim_data$arm == "control"] <- "0"
sim_data$arm[sim_data$arm == "experimental"] <- "1"
head(sim_data)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
devtools::load_all()
#library(wlrt)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
### try changing names and see if it still works
colnames(sim_data) <- c("time", "event", "arm")
sim_data$arm[sim_data$arm == "control"] <- "0"
sim_data$arm[sim_data$arm == "experimental"] <- "1"
head(sim_data)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
scores_1 <- find_scores(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4)
sum(scores_1$df[scores_1$df$group == "experimental","score"])
scores_1
sum(scores_1$df[scores_1$df$group == "1","score"])
plot(scores_1)
x
str(x$df$group)
str(scores_1$df$group)
devtools::load_all()
plot(scores_1)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
#####################################################################
scores_1 <- find_scores(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4)
sum(scores_1$df[scores_1$df$group == "experimental","score"])
plot(scores_1)
devtools::load_all()
#library(wlrt)
set.seed(1)
sim_data <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/9,
lambda_e_1 = log(2)/9,
lambda_e_2 = log(2)/18,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
#example setting t_star
wlrt(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4
)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
#####################################################################
scores_1 <- find_scores(formula=Surv(event_time,event_status)~group,
data=sim_data,
wlr="mw",
t_star = 4)
sum(scores_1$df[scores_1$df$group == "experimental","score"])
plot(scores_1)
### try changing names and see if it still works
colnames(sim_data) <- c("time", "event", "arm")
sim_data$arm[sim_data$arm == "control"] <- "0"
sim_data$arm[sim_data$arm == "experimental"] <- "1"
head(sim_data)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
scores_1 <- find_scores(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4)
sum(scores_1$df[scores_1$df$group == "1","score"])
plot(scores_1)
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
s_star = 0.5
)
#example with 1 strata
sim_data_0 <- sim_data
sim_data_0$ecog=0
sim_data_1 <- sim_events_delay(
n_c = 50,
n_e = 50,
delay_e = 6,
lambda_c = log(2)/6,
lambda_e_1 = log(2)/6,
lambda_e_2 = log(2)/12,
rec_period = 12,
rec_power = 1,
max_cal_t = 36
)
sim_data_1$ecog=1
## rename
colnames(sim_data_1) <- c("time", "event", "arm", "ecog")
sim_data_1$arm[sim_data_1$arm == "control"] <- "0"
sim_data_1$arm[sim_data_1$arm == "experimental"] <- "1"
head(sim_data_1)
sim_data_strata<-rbind(sim_data_0,sim_data_1)
wlrt(formula=Surv(time,event)~arm+strata(ecog),
data=sim_data_strata,
wlr="mw",
t_star = 4
)
#example with 2 strata
sim_data_strata_2<-cbind(sim_data_strata,sex=rep(c("M","F"),times=100))
wlrt(formula=Surv(time,event)~arm+strata(ecog)+strata(sex),
data=sim_data_strata_2,
wlr="mw",
t_star = 4
)
sum(scores_1$df[scores_1$df$group == "experimental","score"])
sum(scores_1$df[scores_1$df$group == "1","score"])
wlrt(formula=Surv(time,event)~arm,
data=sim_data,
wlr="mw",
t_star = 4
)
N <- length(scores_1$df$t_j)
N
M_1 <- length(scores_1$df$t_j[scores_1$df$group == "1"])
M_1
a_bar <- mean(scores_1$df[,"score"])
a_bar
a_hat <- mean(scores_1$df[,"score"]^2)
a_hat
(N - M_1) * M_1 * (a_hat - a_bar ^ 2) / (N - 1)
template <- tempfile(fileext = ".xlsx")
GET(url = "https://static-content.springer.com/esm/art%3A10.1038%2Fs41591-018-0134-3/MediaObjects/41591_2018_134_MOESM3_ESM.xlsx", write_disk(template))
httr::GET(url = "https://static-content.springer.com/esm/art%3A10.1038%2Fs41591-018-0134-3/MediaObjects/41591_2018_134_MOESM3_ESM.xlsx", write_disk(template))
httr::GET(url = "https://static-content.springer.com/esm/art%3A10.1038%2Fs41591-018-0134-3/MediaObjects/41591_2018_134_MOESM3_ESM.xlsx", httr::write_disk(template))
getwd()
?tempfile
readxl::read_excel(template,
sheet = 3)
